name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  PYTHON_VERSION: "3.11"

permissions:
  contents: read
  actions: read

jobs:
  lint:
    name: Lint / format / typecheck
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: [3.11]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements-dev.txt','**/requirements-ml.txt','**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dev / ml dependencies (root)
        run: |
          python -m pip install --upgrade pip
          # main deps if present
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # prefer developer dependencies; fall back to ml deps if dev file missing
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt
          elif [ -f requirements-ml.txt ]; then pip install -r requirements-ml.txt
          else
            echo "No requirements-dev.txt or requirements-ml.txt found at repo root; continuing with requirements.txt (if present)"
          fi

      - name: Black (check)
        run: |
          black --check .

      - name: isort (check)
        run: |
          isort --check-only .

      - name: flake8
        run: |
          flake8 .

      - name: mypy (type checks)
        run: |
          mypy .

  test-backend:
    name: Backend tests (Django)
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python: [3.11]
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: finassist_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:6
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: Cache pip (backend)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-backend-${{ hashFiles('backend/**/requirements*.txt','backend/**/requirements-*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-backend-

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Wait for Postgres
        run: |
          for i in {1..30}; do
            pg_isready -h 127.0.0.1 -p 5432 && break
            echo "Waiting for Postgres..."
            sleep 1
          done

      - name: Export test env vars
        run: |
          echo "DATABASE_URL=postgres://postgres:postgres@127.0.0.1:5432/finassist_test" >> $GITHUB_ENV
          echo "REDIS_URL=redis://127.0.0.1:6379/0" >> $GITHUB_ENV
          echo "DJANGO_SECRET_KEY=ci-test-secret" >> $GITHUB_ENV

      - name: Run Django migrations
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
          DJANGO_SECRET_KEY: ${{ env.DJANGO_SECRET_KEY }}
        run: |
          python manage.py migrate --noinput

      - name: Collect static (optional)
        working-directory: ./backend
        env:
          DJANGO_SECRET_KEY: ${{ env.DJANGO_SECRET_KEY }}
        run: |
          python manage.py collectstatic --noinput || true

      - name: Run backend tests (pytest or Django)
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
          DJANGO_SECRET_KEY: ${{ env.DJANGO_SECRET_KEY }}
        run: |
          if command -v pytest >/dev/null 2>&1; then
            pytest -q --maxfail=1
          else
            python manage.py test --verbosity=2

      - name: Upload coverage to Codecov (optional)
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          fail_ci_if_error: false

  test-ml-service:
    name: ML service tests (ml_service)
    runs-on: ubuntu-latest
    needs: test-backend
    strategy:
      matrix:
        python: [3.11]
    services:
      redis:
        image: redis:6
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: Cache pip for ml_service
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ml-${{ hashFiles('ml_service/**/requirements-ml.txt','ml_service/**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-ml-

      - name: Install ml_service dependencies
        working-directory: ./ml_service
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-ml.txt ]; then pip install -r requirements-ml.txt; fi

      - name: Run ml_service tests
        working-directory: ./ml_service
        env:
          REDIS_URL: redis://127.0.0.1:6379/0
        run: |
          if command -v pytest >/dev/null 2>&1; then
            pytest -q --maxfail=1
          else
            echo "No pytest found in ml_service; skipping tests."
          fi

  docker-build:
    name: Build docker images (optional)
    runs-on: ubuntu-latest
    needs: [test-backend, test-ml-service]
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry (if needed)
        if: ${{ secrets.GHCR_TOKEN != '' }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: false
          tags: ghcr.io/${{ github.repository_owner }}/${{ github.repository }}-backend:ci-${{ github.sha }}

      - name: Build ml_service image
        uses: docker/build-push-action@v4
        with:
          context: ./ml_service
          push: false
          tags: ghcr.io/${{ github.repository_owner }}/${{ github.repository }}-ml:ci-${{ github.sha }}
